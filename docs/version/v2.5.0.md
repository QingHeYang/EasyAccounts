# v2.5.0 版本更新 (AI+图片附件)

**更新日期**：2025-09-19  
**更新视频**：【待录制】

## 重要特性

- **AI功能引入**：集成智能助手功能，使用自己的 API Key 即可体验对话式记账
- **接口反向代理**：API_BASE_URL 配置已成历史，Nginx 自动处理反向代理

## 新增功能

- **流水图片附件**：每条流水记录可以附带三张图片，支持票据、发票等凭证上传
- **AI智能对话**：
  - 自然语言查询账单
  - 语音记账功能
  - 智能数据分析
  - 快速生成报表

## Bug 修复

- 修复追加账单时偶现的小数点后多位问题

## 技术特性

- 增加 nginx 容器反向代理功能，简化部署配置
- 新增 AI 服务容器，支持多种 LLM 提供商

## 升级步骤

### 1. 文件准备

#### AI 配置文件（可选，如需自定义 AI 助手）
从 GitHub 下载配置文件：
- 地址：https://github.com/QingHeYang/EasyAccounts/tree/gh-pages/AI
- 下载 `小易.role` 和 `task.prompt` 两个文件
- 在项目根目录创建 `AI` 文件夹，将文件放入
- 根据个人需要修改配置内容

#### 更新脚本（可选）
如果你自定义过更新脚本，需要添加 AI 镜像拉取命令：
```bash
# 国内镜像
docker pull registry.cn-beijing.aliyuncs.com/easy_accounts/easyaccounts-ai:latest
# 或 Docker Hub
docker pull 775495797/easyaccounts-ai:latest
```
注：直接运行 docker-compose up 会自动拉取，无需手动修改

### 2. Compose 配置修改

#### 删除 Nginx 的 API_BASE_URL（必须）
找到 nginx 服务配置，删除环境变量部分：
```yaml
nginx:
    restart: always
    container_name: easy_accounts_nginx
    image: 775495797/easyaccounts-nginx:latest
    ports:
      - "10669:80"
    # 删除下面这两行
    #environment:
    #  - API_BASE_URL=http://你的IP:10670
```

#### 添加图片目录映射（必须）
在 server 服务的 volumes 中添加：
```yaml
server:
    volumes:
      - ./Resource/sql:/Ledger/backup
      - ./Resource/excel/month:/Ledger/excel/month
      - ./Resource/excel/screen:/Ledger/excel/screen
      - ./Resource/excel/month:/Ledger/excel/analysis
      - ./Resource/images:/Ledger/images         # 新增这一行
      - ./Server/logs:/Ledger/logs
      - ./Server/auth:/Ledger/auth
```

#### 添加 AI 服务（可选）
如果需要 AI 功能，在 compose 文件末尾、networks 之前添加：
```yaml
  ai:
    image: 775495797/easyaccounts-ai:latest  # 国内用阿里云镜像
    container_name: easy_accounts_ai
    restart: always
    environment:
      # 修改为你的 LLM 配置
      - LLM_EASY_ACCOUNTS_API_KEY=sk-your-key-here
      - LLM_EASY_ACCOUNTS_URL=https://api.openai.com/v1
      - LLM_EASY_ACCOUNTS_MODEL=gpt-3.5-turbo
      
    volumes:
      - ./AI/database:/app/koalaq_hub_python/resource/database
      - ./AI/logs:/app/logs
      - ./AI/小易.role:/app/koalaq_hub_python/resource/role/小易.role
      - ./AI/task.prompt:/app/koalaq_hub_python/resource/prompts/layers/task/easy_accounts_instructions.prompt
    
    depends_on:
      - server
    networks:
      - easy_accounts_net
```

### 3. 执行升级

1. **备份数据**：确认 `Resource/sql/` 目录下有最新的自动备份文件

2. **拉取最新代码**：
   ```bash
   git pull origin main
   ```

3. **更新并启动**：
   ```bash
   # 使用国内镜像
   ./update-docker-chinese.sh
   docker-compose -f docker-compose-chinese.yml up -d
   
   # 或使用 Docker Hub
   ./update-docker.sh
   docker-compose up -d
   ```

## 注意事项

- AI 功能需要配置 LLM API Key，支持 OpenAI、Kimi、智谱等服务商
- 图片上传功能会占用存储空间，请确保有足够的磁盘空间
- 升级前请务必备份数据库和重要文件